# agents/reasoning_agent.py

import os
from groq import Groq

# Load API key from environment variable
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

# Fallback (ONLY for development — REMOVE before deployment)
if not GROQ_API_KEY:
    raise ValueError("❌ GROQ_API_KEY is not set. Please set it using: setx GROQ_API_KEY \"your_key_here\"")

# Initialize Groq client
client = Groq(api_key=GROQ_API_KEY)

# Your available model list includes this one:
MODEL_NAME = "llama-3.3-70b-versatile"

SYSTEM_PROMPT = """
You are an advanced medical reasoning agent.

Your job:
- Interpret heart disease prediction results (0=low, 1=high)
- Explain the risk percentage in simple medical terms
- Use the provided structured patient features
- Identify which features contribute to the risk
- Provide safe, non-diagnostic lifestyle guidance
- NEVER give a medical diagnosis
- Explain everything in clear, easy English
"""

def generate_medical_reasoning(prediction: int, risk: float, features: dict):
    """
    Inputs:
      prediction -> 0 or 1
      risk -> probability percentage (float)
      features -> dict of patient health values

    Output:
      A text explanation generated by Groq 70B
    """

    user_message = f"""
Prediction result: {prediction}
Risk Percentage: {risk}%

Patient Data:
{features}

Explain:
- Why this risk level occurred
- Which health features caused it
- What these values mean medically
- What the patient can improve
- Use simple medical reasoning and safe advice
"""

    response = client.chat.completions.create(
        model=MODEL_NAME,
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_message}
        ]
    )

    return response.choices[0].message.content


def medical_chat(question: str, context: dict):
    """
    Allows the user to ask any follow-up question.
    Uses the context:
        - prediction
        - risk
        - patient features
    """

    user_message = f"""
User question: {question}

Patient Context:
{context}

Give a clear, safe, helpful answer.
Do NOT diagnose.
Use simple medical language.
"""

    response = client.chat.completions.create(
        model=MODEL_NAME,
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_message}
        ]
    )

    return response.choices[0].message.content

